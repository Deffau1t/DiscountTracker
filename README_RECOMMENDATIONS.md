# Модуль рекомендаций для DiscountTracker

## Описание

Модуль рекомендаций представляет собой интеллектуальную систему, которая анализирует пользовательское поведение и предпочтения для предоставления персонализированных рекомендаций товаров.

## Архитектура

### Основные компоненты

1. **Сущности (Entities)**
   - `UserPreference` - пользовательские предпочтения по категориям
   - `UserBehavior` - отслеживание поведения пользователей
   - `ProductRecommendation` - сгенерированные рекомендации

2. **Репозитории (Repositories)**
   - `UserPreferenceRepository` - работа с предпочтениями
   - `UserBehaviorRepository` - работа с поведением
   - `ProductRecommendationRepository` - работа с рекомендациями

3. **Сервисы (Services)**
   - `RecommendationService` - основной сервис рекомендаций
   - `UserBehaviorTrackingService` - отслеживание поведения

4. **Контроллеры (Controllers)**
   - `RecommendationController` - REST API и веб-интерфейс

## Алгоритмы рекомендаций

### 1. Content-based фильтрация
- Анализ предпочтений пользователя по категориям
- Учет весов предпочтений (0.0 - 1.0)
- Рекомендации на основе популярных категорий

### 2. Collaborative фильтрация
- Поиск похожих пользователей
- Анализ поведения похожих пользователей
- Рекомендации на основе коллективного опыта

### 3. Гибридный подход
- Объединение результатов различных методов
- Взвешенное ранжирование рекомендаций
- Динамическое обновление оценок

## API Endpoints

### Получение рекомендаций
```
GET /recommendations/api?limit=10
```

### Генерация новых рекомендаций
```
POST /recommendations/api/generate?limit=10
```

### Обновление предпочтений
```
POST /recommendations/api/preferences/update
```

### Отметка как просмотренной
```
POST /recommendations/api/{id}/view
```

## Установка и настройка

### 1. База данных
Выполните SQL скрипт из `src/main/resources/dbScript` для создания необходимых таблиц.

### 2. Конфигурация
Добавьте в `application.properties`:
```properties
# Настройки системы рекомендаций
recommendation.update.cron=0 0 2 * * ?
recommendation.default.limit=10
recommendation.min.similarity=0.3
```

### 3. Зависимости
Убедитесь, что в `pom.xml` есть:
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-jpa</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-thymeleaf</artifactId>
</dependency>
```

## Использование

### Веб-интерфейс
Откройте `/recommendations` для просмотра персональных рекомендаций.

### Программное использование
```java
@Autowired
private RecommendationService recommendationService;

// Генерация рекомендаций
List<RecommendationDto> recommendations = 
    recommendationService.generateRecommendations(user, 10);

// Обновление предпочтений
recommendationService.updateUserPreferences(user);
```

## Отслеживание поведения

Система автоматически отслеживает:
- Просмотры товаров
- Добавления в список наблюдения
- Удаления из списка наблюдения
- Реакции на уведомления о ценах

## Настройка алгоритмов

### Параметры алгоритма
- `minWeight` - минимальный вес предпочтения (по умолчанию 0.5)
- `minSimilarity` - минимальная схожесть пользователей (по умолчанию 0.3)
- `updateInterval` - интервал обновления рекомендаций (по умолчанию 24 часа)

### Кастомизация
Для изменения алгоритмов отредактируйте методы в `RecommendationService`:
- `generateContentBasedRecommendations()` - content-based фильтрация
- `generateCollaborativeRecommendations()` - collaborative фильтрация
- `combineRecommendations()` - гибридный подход

## Тестирование

Запустите тесты:
```bash
mvn test -Dtest=RecommendationServiceTest
```

### Тестирование модуля рекомендаций

Модуль рекомендаций агрегирует результаты нескольких алгоритмов и применяет пост-обработку (категорийный фокус), поэтому корректность важна как на уровне отдельных стратегий, так и при их объединении. Ниже описаны два ключевых юнит‑теста, проверяющихfallback‑поведение и корректное ограничение/маппинг DTO. Эти тесты изолируют сервис с помощью моков репозиториев и зависимостей, чтобы детерминированно проверять бизнес‑логику.

Первый тест проверяет, что при отсутствии поведенческих данных и трендов сервис использует фолбэк‑механику на основе уведомлений, а затем применяет усиление по доминирующей категории пользователя. В результате из набора уведомлений по двум категориям остаются рекомендации только по наиболее частой категории, их количество соответствует лимиту, а итоговый скор увеличен коэффициентом 1.5. Это подтверждает корректность ветки объединения и фильтрации, когда «умные» алгоритмы ничего не вернули.

Второй тест проверяет метод получения уже сохранённых рекомендаций пользователя: результаты сортируются по убыванию скора, применяется заданный лимит и корректно маппятся поля в `RecommendationDto` (идентификатор товара, название, ссылка, категория, алгоритм и скор). Итоговый список содержит ровно заданное количество элементов, а порядок соответствует ожидаемому ранжированию.

В целом, описанные проверки фиксируют критичные инварианты: наличие надёжного фолбэка при пустых данных, корректность пост‑обработки категорий и стабильный контракт DTO при выдаче сохранённых рекомендаций. Расширяя покрытие тестами дополнительных веток (content‑based, collaborative, trend‑based), можно обеспечить уверенную регрессионную защиту и предсказуемость качества рекомендаций при дальнейших изменениях алгоритмов.

## Мониторинг и логи

Система ведет подробные логи:
- Генерация рекомендаций
- Обновление предпочтений
- Отслеживание поведения
- Ошибки и предупреждения

## Производительность

### Оптимизации
- Индексы в базе данных
- Кэширование популярных категорий
- Пакетная обработка рекомендаций
- Асинхронное обновление

### Масштабирование
- Горизонтальное масштабирование через разделение пользователей
- Вертикальное масштабирование через увеличение ресурсов
- Кэширование на уровне приложения

## Безопасность

- Проверка аутентификации пользователя
- Валидация входных данных
- Защита от SQL-инъекций
- Логирование подозрительной активности

## Планы развития

### Краткосрочные (1-2 месяца)
- Улучшение алгоритмов машинного обучения
- Добавление A/B тестирования
- Интеграция с внешними API

### Долгосрочные (3-6 месяцев)
- Реализация deep learning моделей
- Персонализация на основе контекста
- Многомерный анализ предпочтений

## Поддержка

При возникновении проблем:
1. Проверьте логи приложения
2. Убедитесь в корректности данных в БД
3. Проверьте настройки конфигурации
4. Обратитесь к команде разработки

## Лицензия

Проект распространяется под лицензией MIT.

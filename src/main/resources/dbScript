-- PostgreSQL schema for price tracking system
-- DB: price_tracker

CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    role VARCHAR(50) DEFAULT 'USER',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE products (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    url TEXT NOT NULL,
    source VARCHAR(255), -- site domain (e.g., amazon.com)
    category VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE price_history (
    id BIGSERIAL PRIMARY KEY,
    product_id BIGINT NOT NULL REFERENCES products(id) ON DELETE CASCADE,
    price NUMERIC(10, 2) NOT NULL,
    checked_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE notifications (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    product_id BIGINT NOT NULL REFERENCES products(id) ON DELETE CASCADE,
    threshold NUMERIC(10, 2), -- notify if price drops below this
    last_notified TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    notified BOOLEAN
);

-- Indexes for faster lookups
CREATE INDEX idx_price_history_product ON price_history(product_id);
CREATE INDEX idx_notifications_user_product ON notifications(user_id, product_id);

-- Sample roles: USER / ADMIN
-- Future: add Telegram ID or device tokens for push notifications

-- ========================================
-- NEW TABLES FOR RECOMMENDATION SYSTEM
-- ========================================

-- User preferences for categories
CREATE TABLE user_preferences (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    category VARCHAR(100) NOT NULL,
    weight NUMERIC(3, 2) NOT NULL DEFAULT 0.5 CHECK (weight >= 0.0 AND weight <= 1.0),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, category)
);

-- User behavior tracking
CREATE TABLE user_behaviors (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    product_id BIGINT NOT NULL REFERENCES products(id) ON DELETE CASCADE,
    behavior_type VARCHAR(50) NOT NULL, -- 'VIEW', 'WATCH_ADD', 'WATCH_REMOVE', 'NOTIFICATION_CLICK'
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Product recommendations
CREATE TABLE product_recommendations (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    product_id BIGINT NOT NULL REFERENCES products(id) ON DELETE CASCADE,
    score NUMERIC(5, 4) NOT NULL DEFAULT 0.0 CHECK (score >= 0.0 AND score <= 1.0),
    algorithm VARCHAR(50) NOT NULL, -- 'CONTENT_BASED', 'COLLABORATIVE', 'HYBRID'
    is_viewed BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, product_id)
);

-- Indexes for recommendation system
CREATE INDEX idx_user_preferences_user ON user_preferences(user_id);
CREATE INDEX idx_user_preferences_category ON user_preferences(category);
CREATE INDEX idx_user_behaviors_user ON user_behaviors(user_id);
CREATE INDEX idx_user_behaviors_product ON user_behaviors(product_id);
CREATE INDEX idx_user_behaviors_type ON user_behaviors(behavior_type);
CREATE INDEX idx_product_recommendations_user ON product_recommendations(user_id);
CREATE INDEX idx_product_recommendations_score ON product_recommendations(score);
CREATE INDEX idx_product_recommendations_algorithm ON product_recommendations(algorithm);

-- ========================================
-- MIGRATION: FIX COLUMN TYPES TO BIGINT
-- Run these if your existing schema was created with INTEGER/SERIAL
-- ========================================

-- Primary keys
-- ALTER TABLE users ALTER COLUMN id TYPE BIGINT;
-- ALTER TABLE products ALTER COLUMN id TYPE BIGINT;
-- ALTER TABLE price_history ALTER COLUMN id TYPE BIGINT;
-- ALTER TABLE notifications ALTER COLUMN id TYPE BIGINT;

-- Foreign keys to users/products
-- ALTER TABLE price_history ALTER COLUMN product_id TYPE BIGINT;
-- ALTER TABLE notifications ALTER COLUMN user_id TYPE BIGINT;
-- ALTER TABLE notifications ALTER COLUMN product_id TYPE BIGINT;
-- ALTER TABLE user_preferences ALTER COLUMN user_id TYPE BIGINT;
-- ALTER TABLE user_behaviors ALTER COLUMN user_id TYPE BIGINT;
-- ALTER TABLE user_behaviors ALTER COLUMN product_id TYPE BIGINT;
-- ALTER TABLE product_recommendations ALTER COLUMN user_id TYPE BIGINT;
-- ALTER TABLE product_recommendations ALTER COLUMN product_id TYPE BIGINT;

-- Note: PostgreSQL allows INT -> BIGINT change in-place when constraints exist.
-- If any ALTER fails due to constraints, drop the specific FK, alter the column, then recreate the FK.

-- ========================================
-- TABLES FOR PC BUILD MODULE
-- ========================================

-- PC Components table (extends products with technical specifications)
CREATE TABLE pc_components (
    id BIGSERIAL PRIMARY KEY,
    product_id BIGINT NOT NULL REFERENCES products(id) ON DELETE CASCADE,
    component_type VARCHAR(50) NOT NULL, -- 'CPU', 'GPU', 'MOTHERBOARD', 'RAM', 'STORAGE', 'PSU', 'CASE', 'COOLER'
    
    -- General characteristics
    manufacturer VARCHAR(255),
    model VARCHAR(255),
    
    -- CPU characteristics
    socket VARCHAR(50), -- 'LGA1700', 'AM4', 'AM5'
    cores INTEGER,
    threads INTEGER,
    base_clock NUMERIC(5, 2), -- GHz
    boost_clock NUMERIC(5, 2), -- GHz
    tdp INTEGER, -- W
    
    -- GPU characteristics
    vram INTEGER, -- GB
    vram_type VARCHAR(50), -- 'GDDR6', 'GDDR6X'
    memory_bandwidth INTEGER,
    
    -- Motherboard characteristics
    form_factor VARCHAR(50), -- 'ATX', 'mATX', 'ITX'
    chipset VARCHAR(100), -- 'B650', 'Z790'
    memory_slots INTEGER,
    max_memory INTEGER, -- GB
    memory_type VARCHAR(50), -- 'DDR4', 'DDR5'
    pcie_slots INTEGER,
    
    -- RAM characteristics
    capacity INTEGER, -- GB
    speed INTEGER, -- MHz
    latency VARCHAR(50), -- 'CL16'
    
    -- Storage characteristics
    capacity_gb INTEGER, -- GB
    storage_type VARCHAR(50), -- 'SSD', 'HDD', 'NVMe'
    read_speed INTEGER, -- MB/s
    write_speed INTEGER, -- MB/s
    interface_type VARCHAR(50), -- 'SATA', 'NVMe', 'PCIe'
    
    -- PSU characteristics
    wattage INTEGER, -- W
    efficiency_rating VARCHAR(50), -- '80+ Bronze', 'Gold', etc.
    modular BOOLEAN,
    
    -- Case characteristics
    case_form_factor VARCHAR(255), -- Supported form factors
    max_gpu_length INTEGER, -- mm
    max_cpu_cooler_height INTEGER, -- mm
    fan_slots INTEGER,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(product_id)
);

-- PC Builds table
CREATE TABLE pc_builds (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    build_name VARCHAR(255),
    description TEXT,
    
    -- Components
    cpu_id BIGINT REFERENCES pc_components(id) ON DELETE SET NULL,
    gpu_id BIGINT REFERENCES pc_components(id) ON DELETE SET NULL,
    motherboard_id BIGINT REFERENCES pc_components(id) ON DELETE SET NULL,
    ram_id BIGINT REFERENCES pc_components(id) ON DELETE SET NULL,
    storage_id BIGINT REFERENCES pc_components(id) ON DELETE SET NULL,
    psu_id BIGINT REFERENCES pc_components(id) ON DELETE SET NULL,
    case_id BIGINT REFERENCES pc_components(id) ON DELETE SET NULL,
    cooler_id BIGINT REFERENCES pc_components(id) ON DELETE SET NULL,
    
    -- Status
    build_status VARCHAR(50) DEFAULT 'DRAFT', -- 'DRAFT', 'COMPLETE', 'INCOMPATIBLE', 'OPTIMIZING'
    compatibility_checked BOOLEAN DEFAULT FALSE,
    compatibility_issues TEXT,
    total_price NUMERIC(10, 2) DEFAULT 0.0,
    is_public BOOLEAN DEFAULT FALSE,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Indexes for PC Build module
CREATE INDEX idx_pc_components_type ON pc_components(component_type);
CREATE INDEX idx_pc_components_product ON pc_components(product_id);
CREATE INDEX idx_pc_components_socket ON pc_components(socket);
CREATE INDEX idx_pc_components_memory_type ON pc_components(memory_type);
CREATE INDEX idx_pc_components_form_factor ON pc_components(form_factor);

CREATE INDEX idx_pc_builds_user ON pc_builds(user_id);
CREATE INDEX idx_pc_builds_status ON pc_builds(build_status);
CREATE INDEX idx_pc_builds_public ON pc_builds(is_public);
CREATE INDEX idx_pc_builds_cpu ON pc_builds(cpu_id);
CREATE INDEX idx_pc_builds_gpu ON pc_builds(gpu_id);
CREATE INDEX idx_pc_builds_motherboard ON pc_builds(motherboard_id);
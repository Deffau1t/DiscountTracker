<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Рекомендации - Discount Tracker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Чёрно-белая тема */
        body { background: #fff; color: #000; }
        .card { background: #fff; color: #000; border-color: #000 !important; }
        .btn, .badge { border-color: #000 !important; }
        .btn { color: #000; background: #fff; }
        .btn:hover { background: #000; color: #fff; }
        .btn-outline-dark { border-width: 2px; transition: all 0.3s; }
        .btn-outline-dark:hover { transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .recommendation-card { transition: transform 0.2s, box-shadow 0.2s; border: 1px solid #000; }
        .recommendation-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .unviewed-indicator { position: absolute; top: 10px; right: 10px; width: 12px; height: 12px; background-color: #000; border-radius: 50%; }
        .score-badge { font-size: 0.85rem; background: #000; color: #fff; }
        .text-muted { color: #000 !important; opacity: 0.6; }
        .table-dark { background: #000; color: #fff; }
        .badge.bg-primary { background-color: #000 !important; }
        a { color: #000; }
        a:hover { color: #000; text-decoration: underline; }
    </style>
</head>
<body class="container mt-5">
    <!-- Верхняя панель кнопок -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <a href="/watch-list" class="btn btn-outline-dark me-2">
                <i class="fas fa-bell"></i> Мои уведомления
            </a>
            <a href="/watch" class="btn btn-outline-dark me-2">
                <i class="fas fa-plus"></i> Добавить товар
            </a>
            <a href="/recommendations" class="btn btn-outline-dark me-2">
                <i class="fas fa-heart"></i> Рекомендации
            </a>
            <a href="/logout" class="btn btn-outline-dark">
                <i class="fas fa-sign-out-alt"></i> Выйти
            </a>
        </div>
    </div>

    <!-- Заголовок -->
    <div class="mb-4">
        <h3><i class="fas fa-heart me-2" style="color:#000"></i>Персональные рекомендации</h3>
        <p class="text-muted">Подборка товаров на основе ваших предпочтений</p>
    </div>

    <!-- Кнопки управления -->
    <div class="mb-4">
        <button id="generateBtn" class="btn btn-outline-dark me-2">
            <i class="fas fa-magic me-1"></i> Сгенерировать новые
        </button>
        <button id="refreshBtn" class="btn btn-outline-dark">
            <i class="fas fa-sync-alt me-1"></i> Обновить
        </button>
    </div>

    <!-- Пустой список -->
    <div th:if="${#lists.isEmpty(recommendations)}" class="text-center py-5">
        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">Рекомендаций пока нет</h5>
        <p class="text-muted">Нажмите "Сгенерировать новые", чтобы их получить</p>
    </div>

    <!-- Список рекомендаций -->
    <div th:if="${!#lists.isEmpty(recommendations)}" class="row">
        <div th:each="rec : ${recommendations}" class="col-lg-4 col-md-6 mb-4">
            <div class="card recommendation-card h-100 position-relative">
                <div th:if="${!rec.isViewed}" class="unviewed-indicator" title="Новая рекомендация"></div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="card-title mb-0" th:text="${rec.productName}">Название</h6>
                    </div>
                    <p class="text-muted mb-1"><i class="fas fa-tag me-1"></i><span th:text="${rec.productCategory ?: 'Без категории'}"></span></p>
                    <p class="text-muted mb-2"><i class="fas fa-globe me-1"></i><span th:text="${rec.productSource ?: 'Неизвестный источник'}"></span></p>
                    <small class="text-muted" th:if="${rec.currentPrice}">
                        <i class="fas fa-ruble-sign me-1"></i><span th:text="${#numbers.formatDecimal(rec.currentPrice, 1, 2)}">Цена</span>
                    </small>
                    <div class="mt-3 d-flex gap-2">
                        <a th:href="@{'/recommendations/view/' + ${rec.productId}}" class="btn btn-outline-dark btn-sm flex-fill">
                            <i class="fas fa-external-link-alt me-1"></i> Перейти
                        </a>
                        <button th:data-recommendation-id="${rec.id}" class="btn btn-outline-success btn-sm mark-viewed-btn" th:if="${!rec.isViewed}">
                            <i class="fas fa-check me-1"></i> Просмотрено
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно загрузки -->
    <div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                    <h5>Генерация рекомендаций</h5>
                    <p class="text-muted">Пожалуйста, подождите...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const generateBtn = document.getElementById('generateBtn');
            const refreshBtn = document.getElementById('refreshBtn');
            const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));

            generateBtn.addEventListener('click', function() {
                loadingModal.show();
                fetch('/recommendations/api/generate?limit=20', { method: 'POST' })
                    .then(r => r.json())
                    .then(data => {
                        loadingModal.hide();
                        if (data.length > 0) location.reload();
                        else alert('Не удалось сгенерировать рекомендации.');
                    })
                    .catch(() => {
                        loadingModal.hide();
                        alert('Ошибка при генерации.');
                    });
            });

            refreshBtn.addEventListener('click', function() {
                location.reload();
            });

            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('mark-viewed-btn')) {
                    const id = e.target.dataset.recommendationId;
                    const btn = e.target;
                    fetch(`/recommendations/api/${id}/view`, { method: 'POST' })
                        .then(r => r.text())
                        .then(data => {
                            if (data === 'Success') {
                                btn.innerHTML = '<i class="fas fa-check me-1"></i>Просмотрено';
                                btn.classList.remove('btn-outline-success');
                                btn.classList.add('btn-success');
                                btn.disabled = true;
                                const indicator = btn.closest('.recommendation-card').querySelector('.unviewed-indicator');
                                if (indicator) indicator.remove();
                            }
                        });
                }
            });
        });
    </script>
</body>
</html>
